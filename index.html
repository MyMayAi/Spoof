<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Chef Academy 2026 - Touch Reset</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { --p-level: 0%; }
    /* RIMOSSO touch-action: none dal body per sbloccare i tasti */
    body { font-family: sans-serif; background: #f1f5f9; margin: 0; padding: 0; overflow: hidden; height: 100vh; }
    
    .header-box { position: relative; z-index: 100; background: #0f172a; padding: 1.2rem; color: white; border-radius: 0 0 2rem 2rem; }
    .liquid-bg { position: absolute; bottom: 0; left: 0; width: 100%; height: var(--p-level); background: rgba(251,191,36,0.2); z-index: 1; pointer-events: none; }

    /* MODAL INFALLIBILE */
    #tool-modal {
        position: fixed; inset: 0; background: rgba(15,23,42,0.98);
        z-index: 99999; display: none; flex-direction: column;
        align-items: center; justify-content: center; padding: 2rem;
    }
    .tool-option {
        background: #1e293b; width: 80%; margin: 8px; padding: 20px;
        border-radius: 20px; color: white; text-align: center; border: 2px solid #334155;
    }

    /* RIGHELLO - L'UNICO CON TOUCH-ACTION NONE */
    #ruler { 
        position: relative; height: 80px; background: white; 
        overflow: hidden; touch-action: none; border-top: 1px solid #e2e8f0;
    }
    .track { display: flex; align-items: flex-end; position: absolute; left: 50%; height: 100%; pointer-events: none; }
    .tack { width: 2px; height: 20px; background: #cbd5e1; margin-right: 20px; flex-shrink: 0; }
    .tack.big { height: 40px; background: #64748b; }

    .food-card { background: white; padding: 20px; border-radius: 20px; text-align: center; border: 2px solid transparent; }
    .food-card.active { border-color: #fbbf24; background: #fffbeb; }
  </style>
</head>
<body onclick="unlockAudio()">

  <div id="tool-modal" onclick="closeModal()">
      <div class="text-amber-500 font-bold mb-4">SELEZIONA UTENSILE</div>
      <div id="modal-list" class="w-full flex flex-col items-center"></div>
  </div>

  <div class="flex flex-col h-full">
      <div class="header-box">
          <div class="liquid-bg" id="liquid"></div>
          <div class="relative z-10 flex justify-between items-center">
              <div id="btn-cambia" onclick="openModal(event)" style="cursor: pointer; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 15px; border: 1px solid rgba(255,255,255,0.2);">
                  <div id="curEmoji" class="text-3xl">ðŸ¥„</div>
                  <div class="text-[10px] font-bold text-amber-500 uppercase">Cambia</div>
              </div>
              
              <div class="flex-1 text-right">
                  <div class="text-5xl font-black"><span id="dosi">0</span><span class="text-sm text-amber-500"> DOSI</span></div>
              </div>
          </div>
      </div>

      <main class="flex-1 overflow-y-auto p-4 space-y-4" onclick="closeModal()">
          <div class="grid grid-cols-3 gap-3" id="grid"></div>
      </main>

      <footer class="bg-white">
          <div class="p-4 flex justify-between items-center">
              <button onclick="reset()" class="text-red-500 text-xs font-bold uppercase">Reset</button>
              <div class="text-3xl font-bold"><span id="grams">0</span>g</div>
          </div>
          <div id="ruler">
              <div class="absolute left-1/2 -translate-x-1/2 bottom-0 w-1 h-10 bg-amber-500 z-50"></div>
              <div id="track" class="track"></div>
          </div>
      </footer>
  </div>

<script>
    const db = {
        farina: { e: "ðŸŒ¾", w: { cucchiaio: 12, cucchiaino: 4, tazzina: 60 } },
        olio: { e: "ðŸ«’", w: { cucchiaio: 9, cucchiaino: 3, tazzina: 80 } },
        riso: { e: "ðŸš", w: { cucchiaio: 20, cucchiaino: 7, tazzina: 90 } }
    };
    const tools = { cucchiaio: 'ðŸ¥„', cucchiaino: 'ðŸ´', tazzina: 'â˜•' };
    let state = { food: 'farina', tool: 'cucchiaio', g: 0 };
    let ctx = null, curX = 0;

    function unlockAudio() { if(!ctx) ctx = new AudioContext(); if(ctx.state==='suspended') ctx.resume(); }

    function openModal(e) { 
        e.preventDefault();
        e.stopPropagation(); 
        document.getElementById('tool-modal').style.display = 'flex'; 
    }
    function closeModal() { document.getElementById('tool-modal').style.display = 'none'; }

    function init() {
        // Popola Ingredienti
        const g = document.getElementById('grid');
        Object.keys(db).forEach(k => {
            let d = document.createElement('div');
            d.className = "food-card";
            d.innerHTML = `<span class="text-3xl">${db[k].e}</span>`;
            d.onclick = (e) => { e.stopPropagation(); state.food = k; update(); };
            d.id = "f-"+k;
            g.appendChild(d);
        });

        // Popola Modal
        const ml = document.getElementById('modal-list');
        Object.keys(tools).forEach(k => {
            let d = document.createElement('div');
            d.className = "tool-option";
            d.innerHTML = `${tools[k]} ${k.toUpperCase()}`;
            d.onclick = (e) => { e.stopPropagation(); state.tool = k; update(); closeModal(); };
            ml.appendChild(d);
        });

        // Setup Ruler
        const tr = document.getElementById('track');
        for(let i=0; i<=500; i++) {
            let t = document.createElement('div');
            t.className = i%10===0 ? 'tack big' : 'tack';
            tr.appendChild(t);
        }

        let isD = false, sX = 0;
        const r = document.getElementById('ruler');
        r.addEventListener('touchstart', (e) => { isD = true; sX = e.touches[0].clientX - curX; }, {passive: true});
        window.addEventListener('touchmove', (e) => { 
            if(!isD) return; 
            curX = e.touches[0].clientX - sX; 
            if(curX>0) curX=0; 
            state.g = Math.abs(Math.round(curX/20)); 
            update(); 
        }, {passive: true});
        window.addEventListener('touchend', () => isD = false);

        update();
    }

    function update() {
        const f = db[state.food];
        const tw = f.w[state.tool];
        document.getElementById('dosi').innerText = Math.floor(state.g / tw);
        document.getElementById('grams').innerText = state.g;
        document.getElementById('curEmoji').innerText = tools[state.tool];
        document.getElementById('track').style.transform = `translateX(${curX}px)`;
        document.documentElement.style.setProperty('--p-level', ((state.g/tw)%1*100)+'%');
        document.querySelectorAll('.food-card').forEach(c => c.classList.remove('active'));
        document.getElementById('f-'+state.food).classList.add('active');
    }

    function reset() { curX = 0; state.g = 0; update(); }
    init();
</script>
</body>
</html>
